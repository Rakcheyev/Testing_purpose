      - name: Publish release notes to GitHub Release
        if: steps.tags.outputs.old_tag != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_TAG: ${{ steps.tags.outputs.new_tag }}
        run: |
          RELEASE_BODY=$(awk 'NR>1{print}' docs/RELEASE_NOTES.md)
          gh release create "$NEW_TAG" --notes "$RELEASE_BODY" --target ${{ github.sha }} --repo ${{ github.repository }} || \
          gh release edit "$NEW_TAG" --notes "$RELEASE_BODY" --repo ${{ github.repository }}
name: Generate Release Notes

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Determine tag range
        id: tags
        run: |
          NEW_TAG="${GITHUB_REF#refs/tags/}"
          OLD_TAG=$(git tag --sort=-creatordate | sed -n '2p' || true)
          echo "new_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
          echo "old_tag=$OLD_TAG" >> "$GITHUB_OUTPUT"

      - name: Skip when no previous tag
        if: steps.tags.outputs.old_tag == ''
        run: echo "Only one tag detected; release notes generation skipped."

      - name: Generate release notes
        if: steps.tags.outputs.old_tag != ''
        run: ./scripts/generate_release_notes.sh "${{ steps.tags.outputs.old_tag }}" "${{ steps.tags.outputs.new_tag }}"

      - name: Upload release notes artifact
        if: steps.tags.outputs.old_tag != ''
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: docs/RELEASE_NOTES.md

      - name: Commit and push release notes
        if: steps.tags.outputs.old_tag != ''
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          NEW_TAG: ${{ steps.tags.outputs.new_tag }}
        run: |
          if git diff --quiet docs/RELEASE_NOTES.md; then
            echo "No release notes changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/RELEASE_NOTES.md
          git commit -m "docs: update release notes for ${NEW_TAG}"
          git push origin HEAD:${DEFAULT_BRANCH}
